# README.md

## ğŸ“Œ é¡¹ç›®ç®€ä»‹
æœ¬é¡¹ç›®æä¾›äº†ä¸€ä¸ª **Shadowsocks-libev + ss-manager + iptables å¹¶å‘é™åˆ¶** çš„å…¨å®¹å™¨åŒ–æ–¹æ¡ˆï¼Œèƒ½å¤Ÿå®ç°ï¼š

- å¤šç”¨æˆ·ç®¡ç†ï¼ˆæ¯ä¸ªç”¨æˆ·ç‹¬ç«‹ç«¯å£+å¯†ç ï¼‰  
- åŠ¨æ€æ·»åŠ /åˆ é™¤ç”¨æˆ·ï¼ˆæ— éœ€é‡å¯æœåŠ¡ï¼‰  
- **é™åˆ¶ç”¨æˆ·åªèƒ½åŒæ—¶ä¸€å°è®¾å¤‡åœ¨çº¿**ï¼ˆé€šè¿‡ iptables `connlimit`ï¼‰  
- æ‰¹é‡æ·»åŠ /åˆ é™¤ç”¨æˆ·ï¼ˆMakefile + CSVï¼‰  

é€‚åˆè‡ªç”¨æˆ–å°è§„æ¨¡å¤šç”¨æˆ·åœºæ™¯ã€‚

---

## ğŸ—‚ ç›®å½•ç»“æ„
```
your-folder/
â”œâ”€ .dockerignore
â”œâ”€ docker-compose.yml
â”œâ”€ ss-config.json
â”œâ”€ Makefile
â”œâ”€ users.csv            # æ‰¹é‡ç”¨æˆ·æ–‡ä»¶ï¼ˆå¯é€‰ï¼‰
â””â”€ scripts/
   â”œâ”€ add_user.sh
   â”œâ”€ remove_user.sh
   â””â”€ common.sh
```

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å‡†å¤‡ç¯å¢ƒ
- Linux æœåŠ¡å™¨ï¼ˆUbuntu/Debian/CentOS/Rocky ç­‰å‡å¯ï¼‰  
- å·²å®‰è£… `docker` å’Œ `docker-compose`  
- æœåŠ¡å™¨éœ€è¦æ”¯æŒ `iptables connlimit` æ¨¡å—ï¼ˆå¤§éƒ¨åˆ†å†…æ ¸é»˜è®¤æœ‰ï¼‰  

### 2. å¯åŠ¨æœåŠ¡
```bash
docker compose up -d
# æˆ–
make up
```

ä¼šå¯åŠ¨ä¸¤ä¸ªå®¹å™¨ï¼š
- `ss-manager` â†’ è´Ÿè´£ shadowsocks-libev æ ¸å¿ƒä¸ç”¨æˆ·ç«¯å£ç®¡ç†  
- `ss-guard` â†’ æä¾› iptables + è„šæœ¬å·¥å…·ï¼Œç”¨äºå¹¶å‘é™åˆ¶å’Œç”¨æˆ·ç®¡ç†  

---

## ğŸ‘¥ ç”¨æˆ·ç®¡ç†

### å•ä¸ªç”¨æˆ·
æ·»åŠ ï¼š
```bash
make add USER_PORT=8388 USER_PASS='StrongPass123'
```
åˆ é™¤ï¼š
```bash
make del USER_PORT=8388
```

### æ‰¹é‡ç”¨æˆ·
ç”Ÿæˆæ¨¡æ¿ï¼š
```bash
make gen_csv
```
ç¼–è¾‘ `users.csv` æ–‡ä»¶ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
```
8388,userA-pass
8389,userB-pass
8390,userC-pass
```

æ‰¹é‡æ·»åŠ ï¼š
```bash
make bulk_add BULK_FILE=users.csv
```

æ‰¹é‡åˆ é™¤ï¼š
```bash
make bulk_del BULK_FILE=users.csv
```

---

## ğŸ“Š ç›‘æ§ä¸è°ƒè¯•

æŸ¥çœ‹ ss-manager æµé‡ç»Ÿè®¡ï¼š
```bash
make stats
```

æŸ¥çœ‹å½“å‰ iptables é™åˆ¶è§„åˆ™ï¼š
```bash
make ipt_list
```

æ‰¹é‡æ¸…ç†è§„åˆ™ï¼ˆæŒ‡å®šç«¯å£åŒºé—´ï¼‰ï¼š
```bash
make ipt_clear_range PORT_START=8388 PORT_END=8399
```

è‡ªæ£€ï¼ˆæµ‹è¯•æ·»åŠ /åˆ é™¤æµç¨‹ï¼‰ï¼š
```bash
make selftest
```

---

## ğŸ”’ å¹¶å‘é™åˆ¶åŸç†

- **TCP**ï¼šé€šè¿‡ `iptables -m connlimit`ï¼Œé™åˆ¶ `--connlimit-above 1`ï¼Œè¶…è¿‡ 1 æ¡å¹¶å‘è¿æ¥æ—¶æ‹’ç»ï¼ˆè¿”å› RSTï¼‰ã€‚  
- **UDP**ï¼šåŒæ ·é€šè¿‡ connlimit é™åˆ¶è¶…è¿‡ 1 ä¸ªâ€œconntrack æ¡ç›®â€æ—¶ä¸¢å¼ƒæ–°è¯·æ±‚ã€‚  
- è¿™æ ·å¯ä»¥ç¡®ä¿â€œåŒä¸€è´¦å·ï¼ˆç«¯å£ï¼‰**åªèƒ½åŒæ—¶åœ¨çº¿ä¸€ä¸ªè®¾å¤‡**â€ã€‚  

---

## âš ï¸ æ³¨æ„äº‹é¡¹
- æ¯ä¸ªç”¨æˆ·éœ€è¦ç‹¬ç«‹ç«¯å£ï¼Œæ‰èƒ½ç²¾ç¡®åšå¹¶å‘æ§åˆ¶ã€‚  
- é»˜è®¤åªå¤„ç† IPv4ï¼Œå¦‚éœ€ IPv6ï¼Œè¯·åœ¨ `scripts/` ä¸­é¢å¤–æ·»åŠ  `ip6tables` è§„åˆ™ã€‚  
- å»ºè®®ä¸è¦æŠŠ `6001/udp` ç®¡ç†ç«¯å£æš´éœ²å…¬ç½‘ï¼ˆç›®å‰æ˜ å°„äº†å®¿ä¸»æœºç«¯å£ï¼Œå»ºè®®æ”¹æˆ `network_mode: host` å¹¶ç§»é™¤ç«¯å£æ˜ å°„ï¼‰ã€‚  
- å»ºè®®ç”¨æˆ·å¯†ç éšæœºå¤æ‚ï¼Œé¿å…æ’åº“æˆ–çˆ†ç ´ã€‚  

---

## âœ… TODO / å¯æ‰©å±•
- [ ] å¢åŠ  `ip6tables` è§„åˆ™ï¼Œæ”¯æŒ IPv6 ç”¨æˆ·  
- [ ] è‡ªåŠ¨ç»Ÿè®¡å¹¶å‘è¿æ¥ IPï¼Œæ‰©å±•æˆâ€œé™åˆ¶ä¸åŒ IP æ•°é‡â€  
- [ ] æä¾› Web ç®¡ç†ç•Œé¢ï¼ˆè°ƒç”¨ Makefile è„šæœ¬ï¼‰  

---

ğŸ“Œ **ä½¿ç”¨æ–¹æ³•æ€»ç»“**ï¼š  
- **è‡ªç”¨å°‘é‡ç”¨æˆ·** â†’ ç”¨ `make add/del` ç®¡ç†å³å¯  
- **æ‰¹é‡åˆ†é…** â†’ å…ˆ `make gen_csv`ï¼Œç¼–è¾‘ `users.csv`ï¼Œå† `make bulk_add`  
- **é™åˆ¶å¹¶å‘** â†’ å·²è‡ªåŠ¨å¯ç”¨ï¼ˆæ— éœ€é¢å¤–é…ç½®ï¼‰  
